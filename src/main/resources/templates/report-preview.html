<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'æŠ¥å‘Šé¢„è§ˆ - ' + ${runId} + ' - AI Reviewer'">æŠ¥å‘Šé¢„è§ˆ - AI Reviewer</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        /* æŠ¥å‘Šé¢„è§ˆç‰¹å®šæ ·å¼ */
        .report-frame {
            width: 100%;
            min-height: 600px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: white;
            box-shadow: var(--shadow-lg);
        }
        
        .report-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .report-content {
            padding: 2rem;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* è¦†ç›–æŠ¥å‘Šå†…å®¹çš„æ ·å¼ä»¥é€‚é…é¢„è§ˆ */
        .report-content h1, .report-content h2, .report-content h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .report-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        .report-content table th,
        .report-content table td {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        
        .report-content table th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }
        
        .report-content pre {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: var(--radius-md);
            overflow-x: auto;
            font-size: 0.875rem;
        }
        
        .report-content code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
        }
        
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: white;
        }
        
        .fullscreen .report-content {
            max-height: calc(100vh - 80px);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a class="navbar-brand" th:href="@{/dashboard}">
                    ğŸ¤– AI Reviewer
                </a>
                <ul class="navbar-nav" sec:authorize="isAuthenticated()">
                    <li><a class="nav-link" th:href="@{/dashboard}">ä»ªè¡¨æ¿</a></li>
                    <li class="nav-item">
                        <span class="nav-link" sec:authentication="name">ç”¨æˆ·</span>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline btn-sm">é€€å‡ºç™»å½•</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container" th:if="${htmlContent}">
            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <nav class="mb-3">
                <a th:href="@{/dashboard}" class="text-primary">ä»ªè¡¨æ¿</a> / 
                <a th:href="@{'/runs/' + ${runId}}" class="text-primary">è¿è¡Œè¯¦æƒ…</a> / 
                <span class="text-muted">æŠ¥å‘Šé¢„è§ˆ</span>
            </nav>
            
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="mb-4">
                <h1>æŠ¥å‘Šé¢„è§ˆ</h1>
                <p class="text-muted">
                    è¿è¡ŒID: <code th:text="${runId}">run-12345</code>
                </p>
            </div>
            
            <!-- æŠ¥å‘Šæ¡†æ¶ -->
            <div class="report-frame" id="reportFrame">
                <!-- å·¥å…·æ  -->
                <div class="report-toolbar">
                    <div>
                        <span class="text-muted">ğŸ“„ HTML æŠ¥å‘Šé¢„è§ˆ</span>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-outline btn-sm" 
                                onclick="toggleFullscreen()"
                                id="fullscreenBtn">
                            ğŸ” å…¨å±æŸ¥çœ‹
                        </button>
                        <a th:href="@{'/download/' + ${runId} + '/html'}" 
                           class="btn btn-outline btn-sm" 
                           download>
                            ğŸ’¾ ä¸‹è½½HTML
                        </a>
                        <a th:href="@{'/download/' + ${runId} + '/pdf'}" 
                           class="btn btn-primary btn-sm" 
                           download>
                            ğŸ“‘ ä¸‹è½½PDF
                        </a>
                    </div>
                </div>
                
                <!-- æŠ¥å‘Šå†…å®¹ -->
                <div class="report-content" id="reportContent">
                    <!-- ç›´æ¥åµŒå…¥HTMLå†…å®¹ï¼Œéœ€è¦æ³¨æ„XSSå®‰å…¨ -->
                    <div th:utext="${htmlContent}">
                        æŠ¥å‘Šå†…å®¹å°†åœ¨æ­¤å¤„æ˜¾ç¤º
                    </div>
                </div>
            </div>
            
            <!-- è¿”å›æŒ‰é’® -->
            <div class="text-center mt-4">
                <a th:href="@{'/runs/' + ${runId}}" class="btn btn-secondary">
                    â† è¿”å›è¿è¡Œè¯¦æƒ…
                </a>
            </div>
        </div>
        
        <!-- é”™è¯¯é¡µé¢ -->
        <div class="container text-center" th:unless="${htmlContent}" style="padding: 4rem 0;">
            <div style="font-size: 4rem; margin-bottom: 2rem;">ğŸ“„</div>
            <h1>æŠ¥å‘Šé¢„è§ˆä¸å¯ç”¨</h1>
            <p class="text-muted mb-4" th:text="${error ?: 'æ— æ³•åŠ è½½HTMLæŠ¥å‘Šå†…å®¹'}">æ— æ³•åŠ è½½æŠ¥å‘Šå†…å®¹</p>
            <a th:href="@{'/runs/' + ${runId}}" class="btn btn-primary">è¿”å›è¿è¡Œè¯¦æƒ…</a>
        </div>
    </main>
    
    <script>
        // å…¨å±åˆ‡æ¢åŠŸèƒ½
        function toggleFullscreen() {
            const frame = document.getElementById('reportFrame');
            const btn = document.getElementById('fullscreenBtn');
            
            if (frame.classList.contains('fullscreen')) {
                frame.classList.remove('fullscreen');
                btn.innerHTML = 'ğŸ” å…¨å±æŸ¥çœ‹';
                document.body.style.overflow = '';
            } else {
                frame.classList.add('fullscreen');
                btn.innerHTML = 'âŒ é€€å‡ºå…¨å±';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // ESCé”®é€€å‡ºå…¨å±
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const frame = document.getElementById('reportFrame');
                if (frame.classList.contains('fullscreen')) {
                    toggleFullscreen();
                }
            }
        });
        
        // å¹³æ»‘æ»šåŠ¨åˆ°é”šç‚¹
        document.addEventListener('click', function(e) {
            const target = e.target;
            if (target.tagName === 'A' && target.hash) {
                e.preventDefault();
                const element = document.querySelector(target.hash);
                if (element) {
                    element.scrollIntoView({ 
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            }
        });
        
        // ä»£ç å—å¤åˆ¶åŠŸèƒ½
        document.querySelectorAll('pre code').forEach(function(block) {
            const button = document.createElement('button');
            button.className = 'btn btn-outline btn-sm';
            button.innerHTML = 'ğŸ“‹ å¤åˆ¶';
            button.style.position = 'absolute';
            button.style.top = '0.5rem';
            button.style.right = '0.5rem';
            button.style.fontSize = '0.75rem';
            
            const container = block.parentElement;
            container.style.position = 'relative';
            container.appendChild(button);
            
            button.addEventListener('click', async function() {
                try {
                    await navigator.clipboard.writeText(block.textContent);
                    button.innerHTML = 'âœ… å·²å¤åˆ¶';
                    setTimeout(() => {
                        button.innerHTML = 'ğŸ“‹ å¤åˆ¶';
                    }, 2000);
                } catch (err) {
                    button.innerHTML = 'âŒ å¤åˆ¶å¤±è´¥';
                    setTimeout(() => {
                        button.innerHTML = 'ğŸ“‹ å¤åˆ¶';
                    }, 2000);
                }
            });
        });
    </script>
</body>
</html>
