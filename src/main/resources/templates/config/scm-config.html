<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM配置管理 - AI Reviewer</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <meta name="htmx-config" content='{"globalViewTransitions":true}'>
    <style>
        .config-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .provider-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .config-form {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .provider-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .provider-item:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .provider-item.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .provider-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .provider-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .provider-icon.github { background: #24292e; color: white; }
        .provider-icon.gitlab { background: #fc6d26; color: white; }
        .provider-icon.bitbucket { background: #0052cc; color: white; }
        .provider-icon.gitea { background: #609926; color: white; }
        .provider-icon.custom-git { background: #6b7280; color: white; }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-connected { background: #dcfce7; color: #166534; }
        .status-error { background: #fecaca; color: #991b1b; }
        .status-not_configured { background: #fef3c7; color: #92400e; }
        .status-disabled { background: #f3f4f6; color: #6b7280; }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .alert {
            padding: 0.75rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        
        .alert-error {
            background: #fecaca;
            color: #991b1b;
            border: 1px solid #f87171;
        }
        
        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }
        
        .webhook-info {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .webhook-url {
            font-family: monospace;
            background: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .config-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a class="navbar-brand" th:href="@{/dashboard}">
                    🤖 AI Reviewer
                </a>
                <ul class="navbar-nav" sec:authorize="isAuthenticated()">
                    <li><a class="nav-link" th:href="@{/dashboard}">仪表板</a></li>
                    <li><a class="nav-link active" th:href="@{/config}">配置管理</a></li>
                    <li class="nav-item">
                        <span class="nav-link" sec:authentication="name">用户</span>
                    </li>
                    <li class="nav-item">
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline btn-sm">退出登录</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- 页面标题 -->
            <div class="mb-4">
                <h1>SCM配置管理</h1>
                <p class="text-muted">配置和管理多个Git平台的连接设置</p>
            </div>

            <!-- 错误消息 -->
            <div th:if="${error}" class="alert alert-error">
                <span th:text="${error}">错误消息</span>
            </div>

            <div class="config-grid">
                <!-- 左侧：提供商列表 -->
                <div class="provider-list">
                    <h3>支持的Git平台</h3>
                    <div id="provider-list" 
                         hx-get="/config/scm/list" 
                         hx-trigger="load">
                        <!-- 配置列表将通过HTMX加载 -->
                    </div>
                </div>

                <!-- 右侧：配置表单 -->
                <div class="config-form">
                    <div id="config-form">
                        <div style="text-align: center; padding: 2rem; color: #6b7280;">
                            <p>请选择一个Git平台进行配置</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // 测试连接功能
        function testConnection(provider) {
            const form = document.querySelector('#config-form form');
            if (!form) return;
            
            const formData = new FormData(form);
            const config = {};
            for (let [key, value] of formData.entries()) {
                config[key] = value;
            }
            config.provider = provider;
            
            const testBtn = document.querySelector('#test-btn');
            const originalText = testBtn.textContent;
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';
            
            fetch('/config/scm/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                const alertDiv = document.querySelector('#test-result') || document.createElement('div');
                alertDiv.id = 'test-result';
                alertDiv.className = data.success ? 'alert alert-success' : 'alert alert-error';
                alertDiv.textContent = data.success ? 
                    `连接测试成功: ${data.data.message}` : 
                    `连接测试失败: ${data.message}`;
                
                form.insertBefore(alertDiv, form.firstChild);
                
                // 3秒后移除消息
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.parentNode.removeChild(alertDiv);
                    }
                }, 3000);
            })
            .catch(error => {
                console.error('Test connection error:', error);
                alert('连接测试失败: ' + error.message);
            })
            .finally(() => {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            });
        }
        
        // 复制webhook URL
        function copyWebhookUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('Webhook URL已复制到剪贴板');
            });
        }
        
        // 切换配置启用状态
        function toggleProvider(provider) {
            fetch(`/config/scm/${provider}/toggle`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 刷新配置列表
                    htmx.trigger('#provider-list', 'refresh');
                } else {
                    alert('操作失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Toggle error:', error);
                alert('操作失败: ' + error.message);
            });
        }
    </script>
</body>
</html>
