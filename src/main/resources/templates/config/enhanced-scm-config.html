<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCMé…ç½®ç®¡ç† - AI Reviewer</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <meta name="htmx-config" content='{"globalViewTransitions":true}'>
    
    <style>
        .config-grid {
            display: grid;
            grid-template-columns: 350px 1fr 320px;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .provider-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
        }
        
        .config-form {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
        }
        
        .test-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1.5rem;
            height: fit-content;
        }
        
        .provider-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #e5e5e5;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .provider-item:hover {
            background-color: #f8f9fa;
            border-color: #007bff;
        }
        
        .provider-item.active {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .provider-item.connected {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .provider-item.error {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        
        .provider-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .provider-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
        }
        
        .status-connected { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-not-configured { background-color: #6c757d; }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .form-section h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #007bff;
            color: #007bff;
        }
        
        .btn-outline:hover {
            background-color: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .test-result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .test-result.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .custom-platform-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            border: 1px dashed #007bff;
        }
        
        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        @media (max-width: 1200px) {
            .config-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a class="navbar-brand" th:href="@{/dashboard}">
                    ğŸ¤– AI Reviewer
                </a>
                <ul class="navbar-nav">
                    <li><a class="nav-link" th:href="@{/dashboard}">ğŸ“Š ä»ªè¡¨æ¿</a></li>
                    <li><a class="nav-link active" th:href="@{/config}">âš™ï¸ é…ç½®ç®¡ç†</a></li>
                    <li><a class="nav-link" th:href="@{/models}">ğŸ¤– æ¨¡å‹ç®¡ç†</a></li>
                    <li><a class="nav-link" th:href="@{/api-docs}">ğŸ“– APIæ–‡æ¡£</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main-content">
        <div class="container">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="mb-4">
                <h1>SCMé…ç½®ç®¡ç†</h1>
                <p class="text-muted">é…ç½®å’Œç®¡ç†å¤šä¸ªGitå¹³å°çš„è¿æ¥è®¾ç½®ï¼Œæ”¯æŒè‡ªå®šä¹‰å¹³å°æ¥å…¥</p>
            </div>

            <!-- é”™è¯¯æ¶ˆæ¯ -->
            <div th:if="${error}" class="alert alert-error mb-3">
                <span th:text="${error}">é”™è¯¯æ¶ˆæ¯</span>
            </div>

            <div class="config-grid">
                <!-- å·¦ä¾§ï¼šæä¾›å•†åˆ—è¡¨ -->
                <div class="provider-list">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Gitå¹³å°</h3>
                        <button class="btn btn-outline btn-sm" onclick="showAddCustomPlatform()">
                            + æ·»åŠ è‡ªå®šä¹‰
                        </button>
                    </div>
                    
                    <div id="provider-list">
                        <!-- é»˜è®¤å¹³å° -->
                        <div th:if="${scmConfigs != null and !scmConfigs.empty}">
                            <div th:each="config : ${scmConfigs}" class="provider-item" 
                                 th:data-provider="${config.provider}"
                                 th:classappend="${config.status == 'connected'} ? 'connected' : (${config.status == 'error'} ? 'error' : '')">
                                <div class="provider-name">
                                    <span th:switch="${config.provider}">
                                        <span th:case="'github'">ğŸ™</span>
                                        <span th:case="'gitlab'">ğŸ¦Š</span>
                                        <span th:case="'bitbucket'">ğŸª£</span>
                                        <span th:case="'gitea'">ğŸƒ</span>
                                        <span th:case="*">ğŸ”§</span>
                                    </span>
                                    <span th:text="${config.displayName}">GitHub</span>
                                </div>
                                <div class="provider-status" 
                                     th:classappend="'status-' + ${config.status}"
                                     th:text="${config.status == 'connected'} ? 'å·²è¿æ¥' : 
                                              (${config.status == 'error'} ? 'é”™è¯¯' : 'æœªé…ç½®')">
                                    æœªé…ç½®
                                </div>
                            </div>
                        </div>
                        
                        <!-- é»˜è®¤æ˜¾ç¤ºåŸºç¡€å¹³å°ï¼ˆå½“æ²¡æœ‰é…ç½®æ•°æ®æ—¶ï¼‰ -->
                        <div th:if="${scmConfigs == null or scmConfigs.empty}">
                            <div class="provider-item" data-provider="github">
                                <div class="provider-name">
                                    <span>ğŸ™</span>
                                    <span>GitHub</span>
                                </div>
                                <div class="provider-status status-not-configured">æœªé…ç½®</div>
                            </div>
                            <div class="provider-item" data-provider="gitlab">
                                <div class="provider-name">
                                    <span>ğŸ¦Š</span>
                                    <span>GitLab</span>
                                </div>
                                <div class="provider-status status-not-configured">æœªé…ç½®</div>
                            </div>
                            <div class="provider-item" data-provider="bitbucket">
                                <div class="provider-name">
                                    <span>ğŸª£</span>
                                    <span>Bitbucket</span>
                                </div>
                                <div class="provider-status status-not-configured">æœªé…ç½®</div>
                            </div>
                            <div class="provider-item" data-provider="gitea">
                                <div class="provider-name">
                                    <span>ğŸƒ</span>
                                    <span>Gitea</span>
                                </div>
                                <div class="provider-status status-not-configured">æœªé…ç½®</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ·»åŠ è‡ªå®šä¹‰å¹³å°è¡¨å• -->
                    <div id="custom-platform-form" class="custom-platform-form" style="display: none;">
                        <h4>æ·»åŠ è‡ªå®šä¹‰å¹³å°</h4>
                        <form id="add-custom-form">
                            <div class="form-group">
                                <label>å¹³å°åç§°</label>
                                <input type="text" name="name" placeholder="å¦‚ï¼šè‡ªå»ºGitLab" required>
                            </div>
                            <div class="form-group">
                                <label>API åœ°å€</label>
                                <input type="url" name="apiBase" placeholder="https://git.example.com/api/v4" required>
                            </div>
                            <div class="form-group">
                                <label>ç½‘ç«™åœ°å€</label>
                                <input type="url" name="webBase" placeholder="https://git.example.com">
                            </div>
                            <div class="form-group">
                                <label>API ç±»å‹</label>
                                <select name="apiType">
                                    <option value="gitea">Gitea/Forgejo</option>
                                    <option value="gitlab">GitLab</option>
                                    <option value="github">GitHub Enterprise</option>
                                </select>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button type="button" class="btn btn-primary" onclick="addCustomPlatform()">æ·»åŠ </button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddCustomPlatform()">å–æ¶ˆ</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- ä¸­é—´ï¼šé…ç½®è¡¨å• -->
                <div class="config-form">
                    <div id="config-form-container">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>é€‰æ‹©å·¦ä¾§çš„å¹³å°å¼€å§‹é…ç½®</p>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ï¼šæµ‹è¯•é¢æ¿ -->
                <div class="test-panel">
                    <h3>è¿é€šæ€§æµ‹è¯•</h3>
                    <div id="test-panel-content">
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>é…ç½®å®Œæˆåå¯è¿›è¡Œè¿é€šæ€§æµ‹è¯•</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- é¡µè„š -->
    <footer class="footer">
        <div class="container">
            <div class="text-center text-muted text-small">
                Â© 2024 AI Reviewer. Powered by Spring Boot & Thymeleaf.
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        let selectedProvider = null;
        
        // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // ç»‘å®šå¹³å°é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.provider-item').forEach(item => {
                item.addEventListener('click', function() {
                    const provider = this.getAttribute('data-provider');
                    if (provider) {
                        selectProvider(provider, this);
                    }
                });
            });
        });
        
        // é€‰æ‹©æä¾›å•†
        function selectProvider(provider, element) {
            selectedProvider = provider;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.provider-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // åŠ è½½é…ç½®è¡¨å•
            loadConfigForm(provider);
            
            // åŠ è½½æµ‹è¯•é¢æ¿
            loadTestPanel(provider);
        }
        
        // åŠ è½½é…ç½®è¡¨å•
        function loadConfigForm(provider) {
            const container = document.getElementById('config-form-container');
            container.innerHTML = '<div style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</div>';
            
            fetch(`/config/scm/${provider}/form`)
                .then(response => response.text())
                .then(html => {
                    container.innerHTML = html;
                })
                .catch(error => {
                    container.innerHTML = '<div class="alert alert-error">åŠ è½½é…ç½®è¡¨å•å¤±è´¥</div>';
                });
        }
        
        // åŠ è½½æµ‹è¯•é¢æ¿
        function loadTestPanel(provider) {
            const testPanel = document.getElementById('test-panel-content');
            testPanel.innerHTML = `
                <div class="form-group">
                    <button class="btn btn-success" onclick="testConnection()" id="test-btn">
                        ğŸ” æµ‹è¯•è¿æ¥
                    </button>
                </div>
                <div id="test-result"></div>
                <div id="connection-info" style="margin-top: 15px; font-size: 12px; color: #666;">
                    <strong>æç¤ºï¼š</strong>æµ‹è¯•å°†éªŒè¯APIåœ°å€å¯è®¿é—®æ€§å’Œè®¤è¯ä¿¡æ¯æœ‰æ•ˆæ€§
                </div>
            `;
        }
        
        // æµ‹è¯•è¿æ¥
        function testConnection() {
            if (!selectedProvider) return;
            
            const testBtn = document.getElementById('test-btn');
            const testResult = document.getElementById('test-result');
            
            // æ”¶é›†è¡¨å•æ•°æ®
            const formData = collectFormData();
            if (!formData) {
                testResult.innerHTML = '<div class="test-result error">è¯·å…ˆå®Œæˆå¿…è¦çš„é…ç½®é¡¹</div>';
                return;
            }
            
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            testResult.innerHTML = '';
            
            fetch('/config/scm/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Test response data:', data);
                
                // è®°å½•è°ƒè¯•ä¿¡æ¯
                debugRequest('/config/scm/test', formData, data);
                
                // æ£€æŸ¥ApiResponseæ ¼å¼
                if (data && data.ok === true && data.data && data.data.success === true) {
                    testResult.innerHTML = `
                        <div class="test-result success">
                            <strong>âœ… è¿æ¥æˆåŠŸ!</strong><br>
                            å¹³å°ï¼š${data.data.details ? data.data.details.displayName || selectedProvider : selectedProvider}<br>
                            APIï¼š${data.data.details ? data.data.details.apiBase || formData.apiBase : formData.apiBase}<br>
                            Webhookï¼š${data.data.details ? data.data.details.webhookUrl || '/api/webhooks/' + selectedProvider : '/api/webhooks/' + selectedProvider}
                        </div>
                    `;
                    updateProviderStatus(selectedProvider, 'connected');
                } else {
                    // å¤„ç†é”™è¯¯ä¿¡æ¯
                    let errorMsg = 'è¿æ¥æµ‹è¯•å¤±è´¥';
                    
                    if (data) {
                        // æ£€æŸ¥ApiResponseçš„errorå­—æ®µ
                        if (data.error && data.error.message) {
                            errorMsg = data.error.message;
                        }
                        // æ£€æŸ¥dataä¸­çš„messageï¼ˆæµ‹è¯•ç»“æœï¼‰
                        else if (data.data && data.data.message) {
                            errorMsg = data.data.message;
                        }
                        // å…¼å®¹æ—§æ ¼å¼
                        else if (data.message) {
                            errorMsg = data.message;
                        }
                    }
                    
                    testResult.innerHTML = `
                        <div class="test-result error">
                            <strong>âŒ è¿æ¥å¤±è´¥</strong><br>
                            ${errorMsg}
                        </div>
                    `;
                    updateProviderStatus(selectedProvider, 'error');
                }
            })
            .catch(error => {
                testResult.innerHTML = `
                    <div class="test-result error">
                        <strong>âŒ æµ‹è¯•å¼‚å¸¸</strong><br>
                        ${error.message}
                    </div>
                `;
            })
            .finally(() => {
                testBtn.textContent = 'ğŸ” æµ‹è¯•è¿æ¥';
                testBtn.disabled = false;
            });
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            try {
                if (!selectedProvider) {
                    console.error('No provider selected');
                    return null;
                }
                
                const form = document.querySelector('#config-form-container form');
                if (!form) {
                    console.error('Form not found in config-form-container');
                    return null;
                }
                
                const config = {
                    provider: selectedProvider
                };
                
                // æ”¶é›†æ‰€æœ‰è¡¨å•å­—æ®µ
                const inputs = form.querySelectorAll('input, select, textarea');
                console.log('Found form inputs:', inputs.length);
                
                inputs.forEach((input, index) => {
                    try {
                        const name = input.name;
                        if (!name) {
                            console.warn(`Input ${index} has no name attribute`);
                            return;
                        }
                        
                        if (input.type === 'checkbox') {
                            config[name] = input.checked;
                        } else if (input.type === 'radio') {
                            if (input.checked) {
                                config[name] = input.value || '';
                            }
                        } else {
                            const value = (input.value || '').trim();
                            if (value !== '') {
                                config[name] = value;
                            }
                        }
                        
                        console.log(`Processed field: ${name} = ${input.type === 'password' ? '[hidden]' : config[name]}`);
                    } catch (inputError) {
                        console.error(`Error processing input ${index}:`, inputError);
                    }
                });
                
                // éªŒè¯å¿…éœ€å­—æ®µ
                if (!validateConfigData(config)) {
                    console.error('Config validation failed');
                    return null;
                }
                
                console.log('Successfully collected form data:', config);
                return config;
                
            } catch (error) {
                console.error('Error in collectFormData:', error);
                return null;
            }
        }
        
        // éªŒè¯é…ç½®æ•°æ®
        function validateConfigData(config) {
            try {
                // åŸºç¡€éªŒè¯
                if (!config || typeof config !== 'object') {
                    console.error('Config is null or not an object:', config);
                    alert('é…ç½®æ•°æ®æ— æ•ˆ');
                    return false;
                }
                
                if (!config.provider || typeof config.provider !== 'string' || config.provider.trim() === '') {
                    console.error('Provider is invalid:', config.provider);
                    alert('æä¾›å•†ä¿¡æ¯ç¼ºå¤±');
                    return false;
                }
                
                if (!config.apiBase || typeof config.apiBase !== 'string' || config.apiBase.trim() === '') {
                    console.error('API base is invalid:', config.apiBase);
                    alert('APIåœ°å€ä¸èƒ½ä¸ºç©º');
                    return false;
                }
                
                // URLæ ¼å¼éªŒè¯
                try {
                    new URL(config.apiBase);
                } catch (e) {
                    console.error('Invalid URL format:', config.apiBase, e);
                    alert('APIåœ°å€æ ¼å¼æ— æ•ˆ: ' + config.apiBase);
                    return false;
                }
                
                // æä¾›å•†ç‰¹å®šéªŒè¯
                switch (config.provider) {
                    case 'github':
                    case 'gitlab':
                    case 'gitea':
                        if (!config.token || typeof config.token !== 'string' || config.token.trim() === '') {
                            console.error('Token is invalid for provider:', config.provider, 'token:', config.token);
                            alert('è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º');
                            return false;
                        }
                        break;
                    case 'bitbucket':
                        if (!config.username || typeof config.username !== 'string' || config.username.trim() === '') {
                            console.error('Username is invalid for bitbucket:', config.username);
                            alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
                            return false;
                        }
                        if (!config.appPassword || typeof config.appPassword !== 'string' || config.appPassword.trim() === '') {
                            console.error('App password is invalid for bitbucket:', config.appPassword);
                            alert('åº”ç”¨å¯†ç ä¸èƒ½ä¸ºç©º');
                            return false;
                        }
                        break;
                    case 'custom-git':
                        if (!config.token || typeof config.token !== 'string' || config.token.trim() === '') {
                            console.error('Token is invalid for custom-git:', config.token);
                            alert('è®¿é—®ä»¤ç‰Œä¸èƒ½ä¸ºç©º');
                            return false;
                        }
                        // apiType å¯ä»¥ä¸ºç©ºï¼Œä¼šä½¿ç”¨é»˜è®¤å€¼
                        break;
                    default:
                        // å¯¹äºè‡ªå®šä¹‰providerï¼Œæ£€æŸ¥æ˜¯å¦ä»¥custom-å¼€å¤´
                        if (!config.provider.startsWith('custom-')) {
                            console.warn('Unknown provider:', config.provider);
                        }
                        break;
                }
                
                console.log('Config validation passed for provider:', config.provider);
                return true;
                
            } catch (error) {
                console.error('Error in validateConfigData:', error);
                alert('é…ç½®éªŒè¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
                return false;
            }
        }
        
        // æ›´æ–°æä¾›å•†çŠ¶æ€
        function updateProviderStatus(provider, status) {
            const providerItems = document.querySelectorAll('.provider-item');
            providerItems.forEach(item => {
                // ä½¿ç”¨data-providerå±æ€§æ¥åŒ¹é…ï¼Œè€Œä¸æ˜¯onclick
                const itemProvider = item.getAttribute('data-provider');
                if (itemProvider === provider) {
                    const statusElement = item.querySelector('.provider-status');
                    if (statusElement) {
                        statusElement.className = 'provider-status status-' + status;
                        statusElement.textContent = status === 'connected' ? 'å·²è¿æ¥' : 
                                                  status === 'error' ? 'é”™è¯¯' : 'æœªé…ç½®';
                    }
                    
                    // æ›´æ–°itemçš„classï¼Œç§»é™¤æ—§çš„çŠ¶æ€class
                    item.className = item.className.replace(/\s*(connected|error)\s*/g, '');
                    if (status === 'connected') {
                        item.classList.add('connected');
                    } else if (status === 'error') {
                        item.classList.add('error');
                    }
                }
            });
        }
        
        // æ˜¾ç¤ºæ·»åŠ è‡ªå®šä¹‰å¹³å°è¡¨å•
        function showAddCustomPlatform() {
            document.getElementById('custom-platform-form').style.display = 'block';
        }
        
        // éšè—æ·»åŠ è‡ªå®šä¹‰å¹³å°è¡¨å•
        function hideAddCustomPlatform() {
            document.getElementById('custom-platform-form').style.display = 'none';
            document.getElementById('add-custom-form').reset();
        }
        
        // æ·»åŠ è‡ªå®šä¹‰å¹³å°
        function addCustomPlatform() {
            const form = document.getElementById('add-custom-form');
            const formData = new FormData(form);
            const platformData = {};
            
            for (let [key, value] of formData.entries()) {
                platformData[key] = value;
            }
            
            fetch('/config/scm/custom', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(platformData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°æ·»åŠ çš„å¹³å°
                    location.reload();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                alert('æ·»åŠ å¤±è´¥ï¼š' + error.message);
            });
        }
        
        // ä¿å­˜é…ç½®
        function saveConfig() {
            if (!selectedProvider) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå¹³å°');
                return;
            }
            
            console.log('Starting to save config for provider:', selectedProvider);
            
            const formData = collectFormData();
            if (!formData) {
                console.error('Failed to collect form data');
                return;
            }
            
            // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
            const saveBtn = document.querySelector('button[onclick="saveConfig()"]');
            const originalText = saveBtn ? saveBtn.textContent : '';
            if (saveBtn) {
                saveBtn.textContent = 'ä¿å­˜ä¸­...';
                saveBtn.disabled = true;
            }
            
            console.log('Sending request to save config:', formData);
            
            fetch('/config/scm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                console.log('Save response status:', response.status, 'status text:', response.statusText);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                // æ£€æŸ¥Content-Type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.warn('Response is not JSON, content-type:', contentType);
                    return response.text().then(text => {
                        console.error('Non-JSON response:', text);
                        throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('Save response data:', data);
                
                // è®°å½•è°ƒè¯•ä¿¡æ¯
                debugRequest('/config/scm', formData, data);
                
                // æ£€æŸ¥ApiResponseæ ¼å¼ï¼š{ ok: boolean, data: T, error: { code: string, message: string } }
                if (data && data.ok === true) {
                    showMessage('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                    updateProviderStatus(selectedProvider, 'connected');
                    
                    // åˆ·æ–°é…ç½®åˆ—è¡¨
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    // è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å¤„ç†
                    let errorMsg = 'ä¿å­˜å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯';
                    
                    if (data) {
                        // æ£€æŸ¥errorå¯¹è±¡ä¸­çš„message
                        if (data.error && data.error.message) {
                            errorMsg = data.error.message;
                        }
                        // æ£€æŸ¥errorå¯¹è±¡ä¸­çš„code
                        else if (data.error && data.error.code) {
                            errorMsg = `é”™è¯¯ä»£ç : ${data.error.code}`;
                        }
                        // æ£€æŸ¥ç›´æ¥çš„messageå­—æ®µï¼ˆå…¼å®¹æ€§ï¼‰
                        else if (data.message) {
                            errorMsg = data.message;
                        }
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§æ ¼å¼çš„successå­—æ®µ
                        else if (data.success === false && data.message) {
                            errorMsg = data.message;
                        }
                    }
                    
                    console.error('Save failed with data:', data);
                    console.error('Error message:', errorMsg);
                    showMessage('ä¿å­˜å¤±è´¥ï¼š' + errorMsg, 'error');
                    
                    // æ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
                    if (console && console.table && data) {
                        console.table(data);
                    }
                }
            })
            .catch(error => {
                console.error('Save request failed:', error);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                let errorMessage = 'ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å™¨å¼‚å¸¸';
                if (error.message) {
                    errorMessage = error.message;
                }
                
                showMessage('ä¿å­˜å¤±è´¥ï¼š' + errorMessage, 'error');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                if (saveBtn) {
                    saveBtn.textContent = originalText || 'ä¿å­˜';
                    saveBtn.disabled = false;
                }
            });
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '9999';
            messageDiv.style.maxWidth = '400px';
            messageDiv.style.padding = '12px';
            messageDiv.style.borderRadius = '4px';
            messageDiv.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            
            // è®¾ç½®æ ·å¼
            switch (type) {
                case 'success':
                    messageDiv.style.backgroundColor = '#d4edda';
                    messageDiv.style.color = '#155724';
                    messageDiv.style.border = '1px solid #c3e6cb';
                    break;
                case 'error':
                    messageDiv.style.backgroundColor = '#f8d7da';
                    messageDiv.style.color = '#721c24';
                    messageDiv.style.border = '1px solid #f5c6cb';
                    break;
                default:
                    messageDiv.style.backgroundColor = '#d1ecf1';
                    messageDiv.style.color = '#0c5460';
                    messageDiv.style.border = '1px solid #bee5eb';
            }
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }
        
        // è°ƒè¯•åŠŸèƒ½ï¼šæ˜¾ç¤ºå®Œæ•´çš„è¯·æ±‚å’Œå“åº”ä¿¡æ¯
        function debugRequest(url, requestData, responseData) {
            console.group('ğŸ” APIè°ƒè¯•ä¿¡æ¯');
            console.log('ğŸ“¤ è¯·æ±‚URL:', url);
            console.log('ğŸ“¤ è¯·æ±‚æ•°æ®:', requestData);
            console.log('ğŸ“¥ å“åº”æ•°æ®:', responseData);
            
            if (responseData) {
                console.log('ğŸ“‹ å“åº”è¯¦æƒ…:');
                console.table({
                    'okå­—æ®µ': responseData.ok,
                    'dataå­—æ®µ': responseData.data ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    'errorå­—æ®µ': responseData.error ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨',
                    'successå­—æ®µ': responseData.success !== undefined ? responseData.success : 'ä¸å­˜åœ¨'
                });
                
                if (responseData.error) {
                    console.log('âŒ é”™è¯¯è¯¦æƒ…:', responseData.error);
                }
                
                if (responseData.data) {
                    console.log('âœ… æ•°æ®è¯¦æƒ…:', responseData.data);
                }
            }
            console.groupEnd();
        }
        
        // å¿«é€Ÿè¯Šæ–­åŠŸèƒ½
        function quickDiagnose() {
            console.group('ğŸ¥ å¿«é€Ÿè¯Šæ–­');
            console.log('å½“å‰é€‰æ‹©çš„æä¾›å•†:', selectedProvider || 'null');
            
            // æ£€æŸ¥DOMå…ƒç´ 
            const form = document.querySelector('#config-form-container form');
            console.log('è¡¨å•å…ƒç´ :', form ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°');
            
            if (form) {
                const inputs = form.querySelectorAll('input, select, textarea');
                console.log('ğŸ“ è¡¨å•å­—æ®µæ•°é‡:', inputs.length);
                
                // æ˜¾ç¤ºè¡¨å•å­—æ®µè¯¦æƒ…
                console.group('ğŸ“‹ è¡¨å•å­—æ®µè¯¦æƒ…');
                inputs.forEach((input, index) => {
                    console.log(`å­—æ®µ${index + 1}:`, {
                        name: input.name || 'unnamed',
                        type: input.type || 'unknown',
                        value: input.type === 'password' ? '[éšè—]' : (input.value || 'empty'),
                        required: input.required || false
                    });
                });
                console.groupEnd();
                
                // å°è¯•æ”¶é›†è¡¨å•æ•°æ®
                try {
                    const formData = collectFormData();
                    if (formData) {
                        console.log('âœ… è¡¨å•æ•°æ®æ”¶é›†æˆåŠŸ');
                        console.table(formData);
                    } else {
                        console.log('âŒ è¡¨å•æ•°æ®æ”¶é›†å¤±è´¥ - collectFormDataè¿”å›null');
                    }
                } catch (error) {
                    console.error('âŒ è¡¨å•æ•°æ®æ”¶é›†å¼‚å¸¸:', error);
                }
            }
            
            // æ£€æŸ¥provider items
            const providerItems = document.querySelectorAll('.provider-item');
            console.log('æä¾›å•†åˆ—è¡¨é¡¹æ•°é‡:', providerItems.length);
            
            console.groupEnd();
        }
        
        // åœ¨æ§åˆ¶å°æä¾›å¿«é€Ÿè¯Šæ–­å‘½ä»¤
        window.quickDiagnose = quickDiagnose;
    </script>
</body>
</html>
