<!DOCTYPE html>
<html lang="zh-CN" 
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å‹ç®¡ç† - AI Reviewer</title>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" th:href="@{/css/main.css}">
    
    
    <meta name="htmx-config" content='{"globalViewTransitions":true}'>
    <style>
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .model-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .model-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .model-header {
            display: flex;
            justify-content: between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .model-info {
            flex: 1;
        }
        
        .model-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .model-icon {
            font-size: 1.25rem;
        }
        
        .model-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .model-type {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        
        .model-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-connected {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-configured {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-disabled {
            background: #f3f4f6;
            color: #4b5563;
        }
        
        .model-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .model-actions-row {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            text-align: center;
        }
        
        .btn-small:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        
        .btn-primary {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-warning {
            background: #f59e0b;
            border-color: #f59e0b;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.25rem;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #111827;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin: 2rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .model-description {
            font-size: 0.875rem;
            color: #6b7280;
            line-height: 1.4;
            margin: 0.5rem 0;
        }
        
        .model-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        .model-stat {
            display: flex;
            justify-content: space-between;
        }
        
        .toggle-switch {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        .toggle-switch input[type="checkbox"] {
            display: none;
        }
        
        .toggle-switch label {
            display: block;
            width: 44px;
            height: 24px;
            background: #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s ease;
        }
        
        .toggle-switch label:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s ease;
        }
        
        .toggle-switch input[type="checkbox"]:checked + label {
            background: #10b981;
        }
        
        .toggle-switch input[type="checkbox"]:checked + label:before {
            transform: translateX(20px);
        }
        
        .modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.6) !important;
            align-items: center !important;
            justify-content: center !important;
            z-index: 9999 !important;
            backdrop-filter: blur(2px);
            /* ä¸è®¾ç½®displayï¼Œè®©HTMLçš„style="display: none"ç”Ÿæ•ˆ */
        }
        
        .modal-overlay.show {
            display: flex !important;
        }
        
        .modal {
            background: white !important;
            border-radius: 12px !important;
            padding: 2rem !important;
            max-width: 600px !important;
            width: 90% !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25) !important;
            transform: scale(1) !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 10000 !important;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .close-btn:hover {
            background: #f3f4f6;
        }
        
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .filter-tabs {
            display: flex;
            gap: 0.25rem;
            background: #f3f4f6;
            padding: 0.25rem;
            border-radius: 8px;
        }
        
        .filter-tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        
        .filter-tab.active {
            background: white;
            color: #111827;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body>
    <!-- å¯¼èˆªæ  -->
    <div th:replace="~{fragments/simple-navigation :: main-navigation}"></div>
    
    <main class="main-content">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div th:replace="~{fragments/simple-navigation :: page-header('æ¨¡å‹ç®¡ç†', 'ç®¡ç†AIæ¨¡å‹å’Œé™æ€åˆ†æå·¥å…·é…ç½®', '')}"></div>
    
    <div class="container">
        <!-- æ¶ˆæ¯æç¤º -->
        <div id="message" class="message"></div>
        
        <!-- é”™è¯¯æç¤º -->
        <div th:if="${error}" class="message error" style="display: block;">
            <span th:text="${error}">é”™è¯¯ä¿¡æ¯</span>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid" th:if="${statistics}">
            <div class="stat-card">
                <div class="stat-value" th:text="${statistics.totalModels ?: 0}">0</div>
                <div class="stat-label">æ€»æ¨¡å‹æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${statistics.enabledModels ?: 0}">0</div>
                <div class="stat-label">å·²å¯ç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${statistics.connectedModels ?: 0}">0</div>
                <div class="stat-label">å·²è¿æ¥</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" th:text="${#numbers.formatDecimal(statistics.averageResponseTime ?: 0, 0, 0)}">0</div>
                <div class="stat-label">å¹³å‡å“åº”æ—¶é—´(ms)</div>
            </div>
        </div>
        
        <!-- æ“ä½œæ  -->
        <div class="action-bar">
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterModels('all')">å…¨éƒ¨æ¨¡å‹</button>
                <button class="filter-tab" onclick="filterModels('ai')">AIæ¨¡å‹</button>
                <button class="filter-tab" onclick="filterModels('static')">é™æ€åˆ†æ</button>
            </div>
            
            <div class="action-buttons">
                <button class="btn-small btn-primary" onclick="showAddModelModal()">
                    â• æ·»åŠ æ¨¡å‹
                </button>
                <button class="btn-small btn-warning" onclick="testModal()" title="ç›´æ¥æµ‹è¯•æ¨¡æ€æ¡†">
                    ğŸ§ª æµ‹è¯•æ¨¡æ€æ¡†
                </button>
                <button class="btn-small" onclick="refreshModels()">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
            </div>
        </div>
        
        <!-- AIæ¨¡å‹ -->
        <div th:if="${aiModels != null and !aiModels.isEmpty()}">
            <h2 class="section-title">ğŸ¤– AI æ¨¡å‹</h2>
            <div class="model-grid" id="ai-models">
                <div th:each="model : ${aiModels}" class="model-card" th:attr="data-type=${model.type?.code ?: 'unknown'},data-model-id=${model.id ?: 'unknown'}">
                    <!-- å¯ç”¨/ç¦ç”¨å¼€å…³ -->
                    <div class="toggle-switch">
                        <input type="checkbox" th:id="'toggle-' + ${model.id ?: 'unknown'}" 
                               th:checked="${model.enabled ?: false}"
                               onchange="toggleModelFromEvent(this)">
                        <label th:for="'toggle-' + ${model.id ?: 'unknown'}"></label>
                    </div>
                    
                    <div class="model-header">
                        <div class="model-info">
                            <div class="model-title">
                                <span class="model-icon">ğŸ¤–</span>
                                <h3 class="model-name" th:text="${model.displayName ?: model.name ?: 'æœªçŸ¥æ¨¡å‹'}">æ¨¡å‹åç§°</h3>
                            </div>
                            <div class="model-type" th:text="${model.type?.displayName ?: 'æœªçŸ¥ç±»å‹'}">æ¨¡å‹ç±»å‹</div>
                            <div class="model-status" 
                                 th:classappend="'status-' + ${model.status?.code ?: 'unknown'}">
                                <span>âœ…</span>
                                <span th:text="${model.status?.displayName ?: 'æœªçŸ¥çŠ¶æ€'}">å·²è¿æ¥</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="model-description" th:if="${model.description}" 
                         th:text="${model.description}">æ¨¡å‹æè¿°</div>
                    
                    <div class="model-stats" th:if="${model.totalRequests}">
                        <div class="model-stat">
                            <span>æ€»è¯·æ±‚æ•°</span>
                            <span th:text="${model.totalRequests ?: 0}">0</span>
                        </div>
                        <div class="model-stat">
                            <span>æˆåŠŸç‡</span>
                            <span th:text="${#numbers.formatDecimal(model.successRate ?: 0, 0, 1)} + '%'">0%</span>
                        </div>
                        <div class="model-stat" th:if="${model.averageResponseTime}">
                            <span>å“åº”æ—¶é—´</span>
                            <span th:text="${#numbers.formatDecimal(model.averageResponseTime ?: 0, 0, 0)} + 'ms'">0ms</span>
                        </div>
                        <div class="model-stat" th:if="${model.estimatedCost}">
                            <span>ä¼°ç®—æˆæœ¬</span>
                            <span th:text="'$' + ${#numbers.formatDecimal(model.estimatedCost ?: 0, 0, 2)}">$0.00</span>
                        </div>
                    </div>
                    
                    <div class="model-actions">
                        <div class="model-actions-row">
                            <button class="btn-small btn-success" 
                                    onclick="testModelFromEvent(this)">
                                ğŸ” æµ‹è¯•è¿æ¥
                            </button>
                            <button class="btn-small" 
                                    onclick="editModelFromEvent(this)">
                                âœï¸ ç¼–è¾‘
                            </button>
                        </div>
                        <div class="model-actions-row">
                            <button class="btn-small" 
                                    onclick="cloneModelFromEvent(this)">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                            <button class="btn-small btn-danger" 
                                    onclick="deleteModelFromEvent(this)">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é™æ€åˆ†æå·¥å…· -->
        <div th:if="${staticAnalyzers != null and !staticAnalyzers.isEmpty()}">
            <h2 class="section-title">ğŸ” é™æ€åˆ†æå·¥å…·</h2>
            <div class="model-grid" id="static-analyzers">
                <div th:each="model : ${staticAnalyzers}" class="model-card" th:attr="data-type=${model.type?.code ?: 'unknown'},data-model-id=${model.id ?: 'unknown'}">
                    <!-- å¯ç”¨/ç¦ç”¨å¼€å…³ -->
                    <div class="toggle-switch">
                        <input type="checkbox" th:id="'toggle-' + ${model.id ?: 'unknown'}" 
                               th:checked="${model.enabled ?: false}"
                               onchange="toggleModelFromEvent(this)">
                        <label th:for="'toggle-' + ${model.id ?: 'unknown'}"></label>
                    </div>
                    
                    <div class="model-header">
                        <div class="model-info">
                            <div class="model-title">
                                <span class="model-icon">ğŸ”</span>
                                <h3 class="model-name" th:text="${model.displayName ?: model.name ?: 'æœªçŸ¥å·¥å…·'}">å·¥å…·åç§°</h3>
                            </div>
                            <div class="model-type" th:text="${model.type?.displayName ?: 'é™æ€åˆ†æå·¥å…·'}">é™æ€åˆ†æå·¥å…·</div>
                            <div class="model-status" 
                                 th:classappend="'status-' + ${model.status?.code ?: 'unknown'}">
                                <span>âœ…</span>
                                <span th:text="${model.status?.displayName ?: 'æœªçŸ¥çŠ¶æ€'}">å·²è¿æ¥</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="model-description" th:if="${model.description}" 
                         th:text="${model.description}">å·¥å…·æè¿°</div>
                    
                    <div class="model-stats" th:if="${model.supportedLanguages}">
                        <div class="model-stat">
                            <span>æ”¯æŒè¯­è¨€</span>
                            <span th:text="${model.supportedLanguages ? #lists.size(model.supportedLanguages) : 0}">0</span>
                        </div>
                        <div class="model-stat" th:if="${model.totalRequests}">
                            <span>åˆ†ææ¬¡æ•°</span>
                            <span th:text="${model.totalRequests ?: 0}">0</span>
                        </div>
                    </div>
                    
                    <div class="model-actions">
                        <div class="model-actions-row">
                            <button class="btn-small btn-success" 
                                    onclick="testModelFromEvent(this)">
                                ğŸ” æµ‹è¯•å·¥å…·
                            </button>
                            <button class="btn-small" 
                                    onclick="editModelFromEvent(this)">
                                âœï¸ ç¼–è¾‘
                            </button>
                        </div>
                        <div class="model-actions-row">
                            <button class="btn-small" 
                                    onclick="cloneModelFromEvent(this)">
                                ğŸ“‹ å¤åˆ¶
                            </button>
                            <button class="btn-small btn-danger" 
                                    onclick="deleteModelFromEvent(this)">
                                ğŸ—‘ï¸ åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ç©ºçŠ¶æ€ -->
        <div th:if="${(aiModels == null or aiModels.isEmpty()) and (staticAnalyzers == null or staticAnalyzers.isEmpty())}" class="empty-state">
            <div class="empty-state-icon">ğŸ¤–</div>
            <h3>è¿˜æ²¡æœ‰é…ç½®æ¨¡å‹</h3>
            <p>ç‚¹å‡»"æ·»åŠ æ¨¡å‹"æŒ‰é’®å¼€å§‹é…ç½®æ‚¨çš„ç¬¬ä¸€ä¸ªAIæ¨¡å‹æˆ–é™æ€åˆ†æå·¥å…·</p>
            <button class="btn btn-primary" onclick="showAddModelModal()">
                â• æ·»åŠ æ¨¡å‹
            </button>
        </div>
    </div>
    
    <!-- æ¨¡å‹é…ç½®è¡¨å•æ¨¡æ€æ¡† -->
    <div id="model-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">æ·»åŠ æ¨¡å‹</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="model-form-container">
                <!-- è¡¨å•å†…å®¹å°†é€šè¿‡HTMXåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>
    </main>

    <!-- JavaScript è„šæœ¬ -->
    <script>
        // æ£€æŸ¥å¿…è¦çš„ä¾èµ–æ˜¯å¦åŠ è½½
        function checkDependencies() {
            console.log('Dependencies check completed');
        }
        
        // DOMåŠ è½½å®Œæˆåæ£€æŸ¥ä¾èµ–
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkDependencies, 100);
        });
        
        // å…¨å±€å˜é‡
        let currentModelId = null;
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è¿‡æ»¤å™¨
            filterModels('all');
        });
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = message;
            messageEl.className = 'message ' + type;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
        
        // è¿‡æ»¤æ¨¡å‹
        function filterModels(type) {
            // æ›´æ–°é€‰é¡¹å¡çŠ¶æ€
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ‰¾åˆ°å¯¹åº”çš„é€‰é¡¹å¡å¹¶è®¾ç½®ä¸ºæ´»åŠ¨çŠ¶æ€
            const tabMap = {
                'all': 'å…¨éƒ¨æ¨¡å‹',
                'ai': 'AIæ¨¡å‹', 
                'static': 'é™æ€åˆ†æ'
            };
            
            const targetTab = Array.from(document.querySelectorAll('.filter-tab')).find(tab => 
                tab.textContent.trim() === tabMap[type]
            );
            
            if (targetTab) {
                targetTab.classList.add('active');
            } else if (event && event.target) {
                // å¦‚æœæ˜¯ç‚¹å‡»äº‹ä»¶è§¦å‘ï¼Œç›´æ¥ä½¿ç”¨event.target
                event.target.classList.add('active');
            }
            
            // æ˜¾ç¤º/éšè—æ¨¡å‹å¡ç‰‡
            document.querySelectorAll('.model-card').forEach(card => {
                const modelType = card.getAttribute('data-type');
                if (type === 'all') {
                    card.style.display = 'block';
                } else if (type === 'ai') {
                    card.style.display = (modelType && modelType.includes('ai')) ? 'block' : 'none';
                } else if (type === 'static') {
                    card.style.display = (modelType === 'static-analyzer') ? 'block' : 'none';
                }
            });
        }
        
        // æµ‹è¯•æ¨¡æ€æ¡†åŠŸèƒ½ï¼ˆç®€å•ç›´æ¥çš„æµ‹è¯•ï¼‰
        function testModal() {
            console.log('Testing modal directly...');
            
            const modelModal = document.getElementById('model-modal');
            const formContainer = document.getElementById('model-form-container');
            const modalTitle = document.getElementById('modal-title');
            
            console.log('Elements found:', {
                modelModal: !!modelModal,
                formContainer: !!formContainer,
                modalTitle: !!modalTitle
            });
            
            if (!modelModal) {
                alert('æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°ï¼');
                return;
            }
            
            console.log('Before showing modal:', {
                modalDisplay: modelModal.style.display,
                modalClasses: modelModal.className,
                modalBounds: modelModal.getBoundingClientRect()
            });
            
            modalTitle.textContent = 'ğŸ§ª æµ‹è¯•æ¨¡æ€æ¡†';
            formContainer.innerHTML = '<div style="padding: 30px; text-align: center; background: white; border: 2px solid #007bff; border-radius: 8px;"><h3 style="color: #007bff;">âœ… æ¨¡æ€æ¡†æ­£å¸¸å·¥ä½œï¼</h3><p style="margin: 15px 0;">å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™ä¸ªæ¶ˆæ¯ï¼Œè¯´æ˜æ¨¡æ€æ¡†åŸºç¡€åŠŸèƒ½æ­£å¸¸ã€‚</p><button class="btn btn-primary" onclick="closeModal()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">å…³é—­æµ‹è¯•</button></div>';
            
            // ä½¿ç”¨CSSç±»æ˜¾ç¤ºæ¨¡æ€æ¡†
            modelModal.classList.add('show');
            
            console.log('After showing modal:', {
                modalDisplay: modelModal.style.display,
                modalBounds: modelModal.getBoundingClientRect(),
                computedStyle: window.getComputedStyle(modelModal).display
            });
            
            // æ£€æŸ¥æ˜¯å¦çœŸçš„å¯è§
            setTimeout(() => {
                const rect = modelModal.getBoundingClientRect();
                console.log('Modal visibility check:', {
                    width: rect.width,
                    height: rect.height,
                    top: rect.top,
                    left: rect.left,
                    isVisible: rect.width > 0 && rect.height > 0
                });
                
                if (rect.width === 0 || rect.height === 0) {
                    alert('æ¨¡æ€æ¡†åˆ›å»ºæˆåŠŸä½†ä¸å¯è§ï¼è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚');
                }
            }, 100);
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡å‹æ¨¡æ€æ¡†
        function showAddModelModal() {
            console.log('showAddModelModal called');
            currentModelId = null;
            
            try {
                const modalTitle = document.getElementById('modal-title');
                const modelModal = document.getElementById('model-modal');
                const formContainer = document.getElementById('model-form-container');
                
                console.log('Modal elements:', {
                    modalTitle: modalTitle ? 'found' : 'not found',
                    modelModal: modelModal ? 'found' : 'not found',
                    formContainer: formContainer ? 'found' : 'not found'
                });
                
                if (!modalTitle || !modelModal || !formContainer) {
                    console.error('Required modal elements not found');
                    alert('é¡µé¢åŠ è½½é”™è¯¯ï¼šç¼ºå°‘æ¨¡æ€æ¡†å…ƒç´ ');
                    return;
                }
                
                modalTitle.textContent = 'æ·»åŠ æ¨¡å‹';
                
                // åŠ è½½è¡¨å•ï¼Œé»˜è®¤é€‰æ‹©å•†ä¸šAIç±»å‹
                console.log('Fetching form...');
                fetch('/models/form?type=COMMERCIAL_AI')
                    .then(response => {
                        console.log('Form response status:', response.status);
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.text();
                    })
                    .then(html => {
                        console.log('Form HTML loaded, length:', html.length);
                        formContainer.innerHTML = html;
                        modelModal.classList.add('show');
                        console.log('Modal should now be visible');
                        
                        // ç›´æ¥åˆå§‹åŒ–è¡¨å•å¹¶æ˜¾ç¤ºAIé…ç½®
                        setTimeout(() => {
                            initializeFormAfterLoad();
                        }, 100);
                    })
                    .catch(error => {
                        console.error('åŠ è½½è¡¨å•å¤±è´¥:', error);
                        showMessage('åŠ è½½è¡¨å•å¤±è´¥: ' + error.message, 'error');
                        alert('åŠ è½½è¡¨å•å¤±è´¥: ' + error.message);
                    });
            } catch (e) {
                console.error('showAddModelModal error:', e);
                alert('æ¨¡æ€æ¡†æ‰“å¼€å¤±è´¥: ' + e.message);
            }
        }
        
        // ç¼–è¾‘æ¨¡å‹
        function editModel(modelId) {
            currentModelId = modelId;
            document.getElementById('modal-title').textContent = 'ç¼–è¾‘æ¨¡å‹';
            
            // åŠ è½½è¡¨å•
            fetch(`/models/form?id=${modelId}`)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('model-form-container').innerHTML = html;
                    document.getElementById('model-modal').classList.add('show');
                    
                    // ç›´æ¥åˆå§‹åŒ–è¡¨å•
                    setTimeout(() => {
                        initializeFormAfterLoad();
                    }, 100);
                })
                .catch(error => {
                    console.error('åŠ è½½è¡¨å•å¤±è´¥:', error);
                    showMessage('åŠ è½½è¡¨å•å¤±è´¥', 'error');
                });
        }
        
        // è¡¨å•åŠ è½½åçš„åˆå§‹åŒ–å‡½æ•°
        function initializeFormAfterLoad() {
            console.log('Initializing form after load...');
            
            const typeSelect = document.getElementById('model-type');
            if (typeSelect) {
                console.log('Found model type element:', typeSelect.tagName, 'with value:', typeSelect.value);
                
                // åªä¸ºselectå…ƒç´ æ·»åŠ changeäº‹ä»¶ç›‘å¬å™¨
                if (typeSelect.tagName === 'SELECT') {
                    typeSelect.addEventListener('change', handleFormTypeChange);
                }
                
                // è§¦å‘åˆå§‹åŒ–æ˜¾ç¤ºï¼ˆå¯¹selectå’Œhidden inputéƒ½æœ‰æ•ˆï¼‰
                handleFormTypeChange();
            } else {
                console.error('Model type element not found');
            }
        }
        
        // å¤„ç†è¡¨å•ç±»å‹å˜åŒ–
        function handleFormTypeChange() {
            const typeSelect = document.getElementById('model-type');
            if (!typeSelect) return;
            
            const selectedType = typeSelect.value;
            console.log('Type changed to:', selectedType);
            
            const aiConfig = document.getElementById('ai-config');
            const staticConfig = document.getElementById('static-config');
            
            if (!aiConfig || !staticConfig) {
                console.error('Config sections not found');
                return;
            }
            
            // éšè—æ‰€æœ‰é…ç½®åŒºåŸŸ
            aiConfig.style.display = 'none';
            staticConfig.style.display = 'none';
            
            // æ ¹æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”é…ç½®
            if (selectedType === 'COMMERCIAL_AI' || selectedType === 'LOCAL_AI') {
                console.log('Showing AI config');
                aiConfig.style.display = 'block';
                
                // è®¾ç½®å¿…å¡«å­—æ®µ
                const apiUrlField = document.getElementById('api-url');
                const apiKeyField = document.getElementById('api-key');
                const modelNameField = document.getElementById('model-name-field');
                
                if (apiUrlField && apiKeyField && modelNameField) {
                    apiUrlField.required = true;
                    apiKeyField.required = true;
                    modelNameField.required = true;
                    console.log('Required fields set');
                } else {
                    console.error('Required fields not found:', {
                        apiUrl: !!apiUrlField, 
                        apiKey: !!apiKeyField, 
                        modelName: !!modelNameField
                    });
                }
            } else if (selectedType === 'STATIC_ANALYZER') {
                console.log('Showing static config');
                staticConfig.style.display = 'block';
            }
        }
        
        // ä¿å­˜æ¨¡å‹é…ç½®
        function saveModel(event) {
            event.preventDefault();
            console.log('Saving model...');
            
            const formData = collectFormData();
            
            if (!validateFormData(formData)) {
                return;
            }
            
            const submitButton = document.querySelector('#model-form button[type="submit"]');
            if (!submitButton) {
                console.error('Submit button not found');
                return;
            }
            
            const originalText = submitButton.textContent;
            
            submitButton.textContent = 'ä¿å­˜ä¸­...';
            submitButton.disabled = true;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            console.log('Sending data:', formData);
            
            fetch('/api/models', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Save response:', data);
                if (data.ok) {
                    showMessage('æ¨¡å‹é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                    closeModal();
                    // åˆ·æ–°é¡µé¢
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showMessage('ä¿å­˜å¤±è´¥ï¼š' + (data.error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
            })
            .finally(() => {
                submitButton.textContent = originalText;
                submitButton.disabled = false;
            });
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            const form = document.getElementById('model-form');
            if (!form) {
                console.error('Form not found');
                return null;
            }
            
            const formData = new FormData(form);
            const data = {};
            
            // åŸºç¡€å­—æ®µ
            data.id = formData.get('id') || generateModelId();
            data.name = formData.get('name');
            data.displayName = formData.get('displayName');
            data.type = formData.get('type');
            data.description = formData.get('description');
            data.enabled = formData.has('enabled');
            
            // AIæ¨¡å‹ç‰¹å®šå­—æ®µ
            if (data.type === 'COMMERCIAL_AI' || data.type === 'LOCAL_AI') {
                data.apiUrl = formData.get('apiUrl');
                data.apiKey = formData.get('apiKey');
                data.modelName = formData.get('modelName');
                data.modelVersion = formData.get('modelVersion');
                data.maxTokens = formData.get('maxTokens') ? parseInt(formData.get('maxTokens')) : null;
                data.temperature = formData.get('temperature') ? parseFloat(formData.get('temperature')) : null;
                data.timeoutSeconds = formData.get('timeoutSeconds') ? parseInt(formData.get('timeoutSeconds')) : null;
                data.maxConcurrentRequests = formData.get('maxConcurrentRequests') ? parseInt(formData.get('maxConcurrentRequests')) : null;
                data.topP = formData.get('topP') ? parseFloat(formData.get('topP')) : null;
            }
            
            // é™æ€åˆ†æå·¥å…·ç‰¹å®šå­—æ®µ
            if (data.type === 'STATIC_ANALYZER') {
                data.toolPath = formData.get('toolPath');
                data.configFile = formData.get('configFile');
                
                // å¤„ç†æ•°ç»„å­—æ®µ
                const excludePatterns = formData.get('excludePatterns');
                if (excludePatterns) {
                    data.excludePatterns = excludePatterns.split('\n').filter(p => p.trim());
                }
                
                const supportedLanguages = formData.get('supportedLanguages');
                if (supportedLanguages) {
                    data.supportedLanguages = supportedLanguages.split(',').map(l => l.trim()).filter(l => l);
                }
                
                const supportedFileTypes = formData.get('supportedFileTypes');
                if (supportedFileTypes) {
                    data.supportedFileTypes = supportedFileTypes.split(',').map(t => t.trim()).filter(t => t);
                }
                
                // å¤„ç†ç»´åº¦æ•°ç»„
                const dimensions = form.querySelectorAll('input[name="dimensions"]:checked');
                data.supportedDimensions = Array.from(dimensions).map(d => d.value);
            }
            
            return data;
        }
        
        // éªŒè¯è¡¨å•æ•°æ®
        function validateFormData(data) {
            if (!data) {
                showMessage('è¡¨å•æ•°æ®æ”¶é›†å¤±è´¥', 'error');
                return false;
            }
            
            if (!data.name || data.name.trim() === '') {
                showMessage('æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º', 'error');
                return false;
            }
            
            if (!data.type) {
                showMessage('è¯·é€‰æ‹©æ¨¡å‹ç±»å‹', 'error');
                return false;
            }
            
            // AIæ¨¡å‹ç‰¹å®šéªŒè¯
            if (data.type === 'COMMERCIAL_AI' || data.type === 'LOCAL_AI') {
                if (!data.apiUrl || data.apiUrl.trim() === '') {
                    showMessage('APIåœ°å€ä¸èƒ½ä¸ºç©º', 'error');
                    return false;
                }
                
                if (!data.apiKey || data.apiKey.trim() === '') {
                    showMessage('APIå¯†é’¥ä¸èƒ½ä¸ºç©º', 'error');
                    return false;
                }
                
                if (!data.modelName || data.modelName.trim() === '') {
                    showMessage('æ¨¡å‹åç§°ä¸èƒ½ä¸ºç©º', 'error');
                    return false;
                }
            }
            
            // é™æ€åˆ†æå·¥å…·ç‰¹å®šéªŒè¯
            if (data.type === 'STATIC_ANALYZER') {
                if (!data.toolPath || data.toolPath.trim() === '') {
                    showMessage('å·¥å…·è·¯å¾„ä¸èƒ½ä¸ºç©º', 'error');
                    return false;
                }
            }
            
            return true;
        }
        
        // ç”Ÿæˆæ¨¡å‹ID
        function generateModelId() {
            const typeSelect = document.getElementById('model-type');
            const nameField = document.getElementById('model-name');
            
            if (!typeSelect || !nameField) {
                return 'model-' + Date.now();
            }
            
            const type = typeSelect.value;
            const name = nameField.value;
            
            let prefix = 'model';
            if (type === 'COMMERCIAL_AI') prefix = 'commercial';
            else if (type === 'LOCAL_AI') prefix = 'local';
            else if (type === 'STATIC_ANALYZER') prefix = 'static';
            
            const cleanName = name.toLowerCase().replace(/[^a-z0-9]/g, '-');
            const timestamp = Date.now();
            
            return `${prefix}-${cleanName}-${timestamp}`;
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('model-modal').classList.remove('show');
            currentModelId = null;
        }
        
        // æµ‹è¯•æ¨¡å‹è¿æ¥
        function testModel(modelId) {
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = 'æµ‹è¯•ä¸­...';
            button.disabled = true;
            
            // è·å–æ¨¡å‹é…ç½®
            fetch(`/models/${modelId}/details`)
                .then(response => response.text())
                .then(html => {
                    // ä»è¯¦æƒ…ä¸­æå–æ¨¡å‹é…ç½®
                    return extractModelConfig(html);
                })
                .then(config => {
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    return fetch('/api/models/test', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(config)
                    });
                })
                .then(response => response.json())
                .then(data => {
                    if (data.ok) {
                        showMessage('è¿æ¥æµ‹è¯•æˆåŠŸ', 'success');
                        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage('è¿æ¥æµ‹è¯•å¤±è´¥: ' + (data.error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    }
                })
                .catch(error => {
                    console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
                    showMessage('æµ‹è¯•è¿æ¥å¤±è´¥', 'error');
                })
                .finally(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                });
        }
        
        // åˆ‡æ¢æ¨¡å‹å¯ç”¨çŠ¶æ€
        function toggleModel(modelId) {
            fetch(`/models/${modelId}/toggle`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showMessage(data.data, 'success');
                } else {
                    showMessage('æ“ä½œå¤±è´¥: ' + (data.error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                    // æ¢å¤å¼€å…³çŠ¶æ€
                    const checkbox = document.getElementById(`toggle-${modelId}`);
                    checkbox.checked = !checkbox.checked;
                }
            })
            .catch(error => {
                console.error('åˆ‡æ¢æ¨¡å‹çŠ¶æ€å¤±è´¥:', error);
                showMessage('æ“ä½œå¤±è´¥', 'error');
                // æ¢å¤å¼€å…³çŠ¶æ€
                const checkbox = document.getElementById(`toggle-${modelId}`);
                checkbox.checked = !checkbox.checked;
            });
        }
        
        // ä»äº‹ä»¶ä¸­è·å–æ¨¡å‹IDå¹¶åˆ‡æ¢çŠ¶æ€
        function toggleModelFromEvent(element) {
            const modelCard = element.closest('.model-card');
            const modelId = modelCard ? modelCard.getAttribute('data-model-id') : null;
            if (modelId) {
                toggleModel(modelId);
            } else {
                console.error('æ— æ³•è·å–æ¨¡å‹ID');
                showMessage('æ“ä½œå¤±è´¥ï¼šæ— æ³•è·å–æ¨¡å‹ID', 'error');
            }
        }
        
        // ä»äº‹ä»¶ä¸­è·å–æ¨¡å‹IDå¹¶æµ‹è¯•è¿æ¥
        function testModelFromEvent(element) {
            const modelCard = element.closest('.model-card');
            const modelId = modelCard ? modelCard.getAttribute('data-model-id') : null;
            if (modelId) {
                testModel(modelId);
            } else {
                console.error('æ— æ³•è·å–æ¨¡å‹ID');
                showMessage('æ“ä½œå¤±è´¥ï¼šæ— æ³•è·å–æ¨¡å‹ID', 'error');
            }
        }
        
        // ä»äº‹ä»¶ä¸­è·å–æ¨¡å‹IDå¹¶ç¼–è¾‘
        function editModelFromEvent(element) {
            const modelCard = element.closest('.model-card');
            const modelId = modelCard ? modelCard.getAttribute('data-model-id') : null;
            if (modelId) {
                editModel(modelId);
            } else {
                console.error('æ— æ³•è·å–æ¨¡å‹ID');
                showMessage('æ“ä½œå¤±è´¥ï¼šæ— æ³•è·å–æ¨¡å‹ID', 'error');
            }
        }
        
        // ä»äº‹ä»¶ä¸­è·å–æ¨¡å‹IDå¹¶å¤åˆ¶
        function cloneModelFromEvent(element) {
            const modelCard = element.closest('.model-card');
            const modelId = modelCard ? modelCard.getAttribute('data-model-id') : null;
            if (modelId) {
                cloneModel(modelId);
            } else {
                console.error('æ— æ³•è·å–æ¨¡å‹ID');
                showMessage('æ“ä½œå¤±è´¥ï¼šæ— æ³•è·å–æ¨¡å‹ID', 'error');
            }
        }
        
        // ä»äº‹ä»¶ä¸­è·å–æ¨¡å‹IDå¹¶åˆ é™¤
        function deleteModelFromEvent(element) {
            const modelCard = element.closest('.model-card');
            const modelId = modelCard ? modelCard.getAttribute('data-model-id') : null;
            if (modelId) {
                deleteModel(modelId);
            } else {
                console.error('æ— æ³•è·å–æ¨¡å‹ID');
                showMessage('æ“ä½œå¤±è´¥ï¼šæ— æ³•è·å–æ¨¡å‹ID', 'error');
            }
        }
        
        // åˆ é™¤æ¨¡å‹
        function deleteModel(modelId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å‹é…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            fetch(`/models/${modelId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showMessage('æ¨¡å‹åˆ é™¤æˆåŠŸ', 'success');
                    // åˆ·æ–°é¡µé¢
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + (data.error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                console.error('åˆ é™¤æ¨¡å‹å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥', 'error');
            });
        }
        
        // å¤åˆ¶æ¨¡å‹
        function cloneModel(modelId) {
            fetch(`/models/${modelId}/clone`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showMessage('æ¨¡å‹å¤åˆ¶æˆåŠŸ', 'success');
                    // æ‰“å¼€ç¼–è¾‘è¡¨å•
                    setTimeout(() => {
                        editModel(data.data.id);
                    }, 1000);
                } else {
                    showMessage('å¤åˆ¶å¤±è´¥: ' + (data.error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                console.error('å¤åˆ¶æ¨¡å‹å¤±è´¥:', error);
                showMessage('å¤åˆ¶å¤±è´¥', 'error');
            });
        }
        
        // åˆ·æ–°æ¨¡å‹çŠ¶æ€
        function refreshModels() {
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = 'åˆ·æ–°ä¸­...';
            button.disabled = true;
            
            fetch('/models/refresh', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    showMessage('çŠ¶æ€åˆ·æ–°å®Œæˆ', 'success');
                    // åˆ·æ–°é¡µé¢
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage('åˆ·æ–°å¤±è´¥: ' + (data.error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                console.error('åˆ·æ–°çŠ¶æ€å¤±è´¥:', error);
                showMessage('åˆ·æ–°å¤±è´¥', 'error');
            })
            .finally(() => {
                button.textContent = originalText;
                button.disabled = false;
            });
        }
        
        // ä»HTMLä¸­æå–æ¨¡å‹é…ç½®ï¼ˆç®€åŒ–å®ç°ï¼‰
        function extractModelConfig(html) {
            // è¿™é‡Œåº”è¯¥ä»è¯¦æƒ…HTMLä¸­æå–å®Œæ•´çš„æ¨¡å‹é…ç½®
            // ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œè¿”å›ä¸€ä¸ªåŸºç¡€é…ç½®
            return {
                id: currentModelId,
                name: 'Test Model',
                type: 'COMMERCIAL_AI'
            };
        }
        
        // æµ‹è¯•æ¨¡å‹è¿æ¥ï¼ˆç”¨äºæ¨¡æ€æ¡†ä¸­çš„æµ‹è¯•æŒ‰é’®ï¼‰
        function testModelConnection() {
            const formData = collectFormData();
            
            if (!formData) {
                showMessage('è¯·å…ˆå¡«å†™å¿…è¦çš„é…ç½®ä¿¡æ¯', 'error');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            
            button.textContent = 'æµ‹è¯•ä¸­...';
            button.disabled = true;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            fetch('/api/models/test', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Test response:', data);
                
                if (data.ok && data.data && data.data.success) {
                    showMessage('è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                    
                    // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    if (data.data.details) {
                        const details = data.data.details;
                        console.log('è¿æ¥è¯¦æƒ…:', details);
                    }
                } else {
                    const errorMsg = data.error ? data.error.message : 
                                   data.data ? data.data.message : 'è¿æ¥æµ‹è¯•å¤±è´¥';
                    showMessage('è¿æ¥æµ‹è¯•å¤±è´¥: ' + errorMsg, 'error');
                }
            })
            .catch(error => {
                console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
                showMessage('æµ‹è¯•è¿æ¥å¼‚å¸¸: ' + error.message, 'error');
            })
            .finally(() => {
                button.textContent = originalText;
                button.disabled = false;
            });
        }
        
        // é‡å¤çš„collectFormDataå‡½æ•°å·²ç§»é™¤ï¼Œä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ç‰ˆæœ¬
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.addEventListener('click', function(event) {
            // åªæœ‰ç‚¹å‡»overlayèƒŒæ™¯ï¼ˆä¸æ˜¯modalå†…å®¹ï¼‰æ‰å…³é—­
            if (event.target.id === 'model-modal' && event.target.classList.contains('modal-overlay')) {
                closeModal();
            }
        });
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
    
    <!-- è„šæœ¬æ–‡ä»¶ - æ”¾åœ¨é¡µé¢åº•éƒ¨ç¡®ä¿DOMåŠ è½½å®Œæˆ -->
    <!-- è‡ªå®šä¹‰è„šæœ¬ -->
    <script th:src="@{/js/charts.js}" defer onerror="console.error('Failed to load charts.js')"></script>
</body>
</html>
