<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">

<!-- æ¨¡å‹é…ç½®è¡¨å• -->
<div th:fragment="model-form">
    <form id="model-form" onsubmit="saveModel(event)">
        <!-- åŸºç¡€ä¿¡æ¯ -->
        <div class="form-section">
            <h3 class="form-section-title">åŸºç¡€ä¿¡æ¯</h3>
            
            <div class="form-group">
                <label for="model-name" class="form-label">æ¨¡å‹åç§° *</label>
                <input type="text" id="model-name" name="name" class="form-input" 
                       th:value="${model.name}" required 
                       placeholder="è¯·è¾“å…¥æ¨¡å‹åç§°">
            </div>
            
            <div class="form-group">
                <label for="model-display-name" class="form-label">æ˜¾ç¤ºåç§°</label>
                <input type="text" id="model-display-name" name="displayName" class="form-input" 
                       th:value="${model.displayName}" 
                       placeholder="è¯·è¾“å…¥æ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰">
            </div>
            
            <div class="form-group">
                <label for="model-type" class="form-label">æ¨¡å‹ç±»å‹ *</label>
                <div th:if="${!isNew}" class="form-input-readonly">
                    <span th:text="${model.type?.displayName ?: 'æœªçŸ¥ç±»å‹'}" class="readonly-value">æ¨¡å‹ç±»å‹</span>
                    <small class="form-help">ç¼–è¾‘æ¨¡å¼ä¸‹ä¸èƒ½æ›´æ”¹æ¨¡å‹ç±»å‹</small>
                    <input type="hidden" id="model-type" name="type" th:value="${model.type?.name()}">
                </div>
                <select th:if="${isNew}" id="model-type" name="type" class="form-select" required 
                        onchange="handleFormTypeChange()">
                    <option value="">è¯·é€‰æ‹©æ¨¡å‹ç±»å‹</option>
                    <option th:each="type : ${modelTypes}" 
                            th:value="${type.name()}" 
                            th:text="${type.displayName}"
                            th:selected="${model.type != null and model.type.name() == type.name()}">
                        æ¨¡å‹ç±»å‹
                    </option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="model-description" class="form-label">æè¿°</label>
                <textarea id="model-description" name="description" class="form-textarea" 
                          th:text="${model.description}" 
                          placeholder="è¯·è¾“å…¥æ¨¡å‹æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
            </div>
        </div>
        
        <!-- AIæ¨¡å‹é…ç½® -->
        <div id="ai-config" class="form-section" style="display: none;">
            <h3 class="form-section-title">AIæ¨¡å‹é…ç½®</h3>
            
            <div class="form-group">
                <label for="api-url" class="form-label">APIåœ°å€ *</label>
                <input type="url" id="api-url" name="apiUrl" class="form-input" 
                       th:value="${model.apiUrl}" 
                       placeholder="https://api.openai.com/v1/chat/completions">
            </div>
            
            <div class="form-group">
                <label for="api-key" class="form-label">APIå¯†é’¥ *</label>
                <input type="password" id="api-key" name="apiKey" class="form-input" 
                       th:value="${model.apiKey}" 
                       placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                <small class="form-help">å¯†é’¥å°†è¢«å®‰å…¨å­˜å‚¨ï¼Œä¸ä¼šåœ¨ç•Œé¢ä¸­æ˜¾ç¤º</small>
            </div>
            
            <div class="form-group">
                <label for="model-name-field" class="form-label">æ¨¡å‹åç§° *</label>
                <input type="text" id="model-name-field" name="modelName" class="form-input" 
                       th:value="${model.modelName}" 
                       placeholder="gpt-4o">
            </div>
            
            <div class="form-group">
                <label for="model-version" class="form-label">æ¨¡å‹ç‰ˆæœ¬</label>
                <input type="text" id="model-version" name="modelVersion" class="form-input" 
                       th:value="${model.modelVersion}" 
                       placeholder="v1.0">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="max-tokens" class="form-label">æœ€å¤§ä»¤ç‰Œæ•°</label>
                    <input type="number" id="max-tokens" name="maxTokens" class="form-input" 
                           th:value="${model.maxTokens}" 
                           min="1" max="8192" 
                           placeholder="2000">
                </div>
                
                <div class="form-group">
                    <label for="temperature" class="form-label">æ¸©åº¦å€¼</label>
                    <input type="number" id="temperature" name="temperature" class="form-input" 
                           th:value="${model.temperature}" 
                           min="0" max="2" step="0.1" 
                           placeholder="0.3">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="timeout-seconds" class="form-label">è¶…æ—¶æ—¶é—´(ç§’)</label>
                    <input type="number" id="timeout-seconds" name="timeoutSeconds" class="form-input" 
                           th:value="${model.timeoutSeconds}" 
                           min="10" max="300" 
                           placeholder="60">
                </div>
                
                <div class="form-group">
                    <label for="max-concurrent" class="form-label">æœ€å¤§å¹¶å‘æ•°</label>
                    <input type="number" id="max-concurrent" name="maxConcurrentRequests" class="form-input" 
                           th:value="${model.maxConcurrentRequests}" 
                           min="1" max="20" 
                           placeholder="5">
                </div>
            </div>
        </div>
        
        <!-- é™æ€åˆ†æå·¥å…·é…ç½® -->
        <div id="static-config" class="form-section" style="display: none;">
            <h3 class="form-section-title">é™æ€åˆ†æå·¥å…·é…ç½®</h3>
            
            <div class="form-group">
                <label for="tool-path" class="form-label">å·¥å…·è·¯å¾„ *</label>
                <input type="text" id="tool-path" name="toolPath" class="form-input" 
                       th:value="${model.toolPath}" 
                       placeholder="/usr/local/bin/eslint">
                <small class="form-help">è¯·è¾“å…¥å·¥å…·çš„å®Œæ•´è·¯å¾„</small>
            </div>
            
            <div class="form-group">
                <label for="config-file" class="form-label">é…ç½®æ–‡ä»¶</label>
                <input type="text" id="config-file" name="configFile" class="form-input" 
                       th:value="${model.configFile}" 
                       placeholder=".eslintrc.json">
            </div>
            
            <div class="form-group">
                <label for="supported-languages" class="form-label">æ”¯æŒçš„è¯­è¨€</label>
                <input type="text" id="supported-languages" name="supportedLanguages" class="form-input" 
                       th:value="${model.supportedLanguages != null ? #strings.listJoin(model.supportedLanguages, ', ') : ''}" 
                       placeholder="java, javascript, typescript">
                <small class="form-help">å¤šä¸ªè¯­è¨€ç”¨é€—å·åˆ†éš”</small>
            </div>
            
            <div class="form-group">
                <label for="supported-file-types" class="form-label">æ”¯æŒçš„æ–‡ä»¶ç±»å‹</label>
                <input type="text" id="supported-file-types" name="supportedFileTypes" class="form-input" 
                       th:value="${model.supportedFileTypes != null ? #strings.listJoin(model.supportedFileTypes, ', ') : ''}" 
                       placeholder=".js, .jsx, .ts, .tsx">
                <small class="form-help">å¤šä¸ªæ–‡ä»¶ç±»å‹ç”¨é€—å·åˆ†éš”</small>
            </div>
        </div>
        
        <!-- æ”¯æŒçš„ç»´åº¦ -->
        <div class="form-section">
            <h3 class="form-section-title">æ”¯æŒçš„è´¨é‡ç»´åº¦</h3>
            <div class="checkbox-group">
                <div th:each="dimension : ${dimensions}" class="checkbox-item">
                    <input type="checkbox" th:id="'dim-' + ${dimension.name()}" 
                           name="supportedDimensions" th:value="${dimension.name()}"
                           th:checked="${model.supportedDimensions != null and model.supportedDimensions.contains(dimension)}">
                    <label th:for="'dim-' + ${dimension.name()}" th:text="${dimension.name()}">ç»´åº¦</label>
                </div>
            </div>
        </div>
        
        <!-- é«˜çº§é…ç½® -->
        <div class="form-section">
            <h3 class="form-section-title">é«˜çº§é…ç½®</h3>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="enabled" name="enabled" 
                           th:checked="${model.enabled}">
                    å¯ç”¨æ­¤æ¨¡å‹
                </label>
            </div>
            
            <div class="form-group">
                <label for="exclude-patterns" class="form-label">æ’é™¤æ¨¡å¼</label>
                <textarea id="exclude-patterns" name="excludePatterns" class="form-textarea" 
                          th:text="${model.excludePatterns != null ? #strings.listJoin(model.excludePatterns, '&#10;') : ''}" 
                          placeholder="æ¯è¡Œä¸€ä¸ªæ’é™¤æ¨¡å¼ï¼Œæ”¯æŒé€šé…ç¬¦"></textarea>
                <small class="form-help">ç”¨äºæ’é™¤ä¸éœ€è¦åˆ†æçš„æ–‡ä»¶æˆ–è§„åˆ™</small>
            </div>
        </div>
        
        <!-- éšè—å­—æ®µ -->
        <input type="hidden" id="model-id" name="id" th:value="${model.id}">
        
        <!-- è¡¨å•æŒ‰é’® -->
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">
                å–æ¶ˆ
            </button>
            <button type="button" class="btn btn-outline" onclick="testModelConnection()">
                ğŸ” æµ‹è¯•è¿æ¥
            </button>
            <button type="submit" class="btn btn-primary">
                ğŸ’¾ ä¿å­˜é…ç½®
            </button>
        </div>
    </form>
</div>

<style>
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .form-section-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 1rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    
    .form-input, .form-select, .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.875rem;
        transition: border-color 0.2s ease;
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .form-textarea {
        min-height: 80px;
        resize: vertical;
    }
    
    .form-help {
        display: block;
        font-size: 0.75rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.5rem;
    }
    
    .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .checkbox-item input[type="checkbox"] {
        width: auto;
    }
    
    .form-input-readonly {
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        background-color: #f9fafb;
        font-size: 0.875rem;
    }
    
    .readonly-value {
        font-weight: 500;
        color: #374151;
        display: block;
        margin-bottom: 0.25rem;
    }
    
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid transparent;
        text-decoration: none;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2563eb;
    }
    
    .btn-secondary {
        background: #6b7280;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
    }
    
    .btn-outline {
        background: white;
        color: #374151;
        border-color: #d1d5db;
    }
    
    .btn-outline:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
</style>

<script>
    // åˆå§‹åŒ–è¡¨å•
    document.addEventListener('DOMContentLoaded', function() {
        handleFormTypeChange();
    });
    
    // å¤„ç†æ¨¡å‹ç±»å‹å˜åŒ–
    function handleFormTypeChange() {
        const typeSelect = document.getElementById('model-type');
        if (!typeSelect) return;
        
        // è·å–é€‰ä¸­çš„ç±»å‹ï¼ˆå¯èƒ½æ˜¯selectçš„å€¼æˆ–hidden inputçš„å€¼ï¼‰
        let selectedType = '';
        if (typeSelect.tagName === 'SELECT') {
            selectedType = typeSelect.value;
        } else if (typeSelect.tagName === 'INPUT' && typeSelect.type === 'hidden') {
            selectedType = typeSelect.value;
        }
        
        const aiConfig = document.getElementById('ai-config');
        const staticConfig = document.getElementById('static-config');
        
        if (!aiConfig || !staticConfig) return;
        
        // éšè—æ‰€æœ‰é…ç½®åŒºåŸŸ
        aiConfig.style.display = 'none';
        staticConfig.style.display = 'none';
        
        // æ ¹æ®ç±»å‹æ˜¾ç¤ºå¯¹åº”é…ç½®
        if (selectedType === 'COMMERCIAL_AI' || selectedType === 'LOCAL_AI') {
            aiConfig.style.display = 'block';
            
            // è®¾ç½®å¿…å¡«å­—æ®µ
            const apiUrlField = document.getElementById('api-url');
            const apiKeyField = document.getElementById('api-key');
            const modelNameField = document.getElementById('model-name-field');
            
            if (apiUrlField && apiKeyField && modelNameField) {
                apiUrlField.required = true;
                apiKeyField.required = true;
                modelNameField.required = true;
                
                // è®¾ç½®é»˜è®¤å€¼
                if (selectedType === 'COMMERCIAL_AI') {
                    apiUrlField.placeholder = 'https://api.openai.com/v1/chat/completions';
                    modelNameField.placeholder = 'gpt-4o';
                } else {
                    apiUrlField.placeholder = 'http://localhost:11434/api/generate';
                    modelNameField.placeholder = 'deepseek-coder:6.7b';
                }
            }
        } else if (selectedType === 'STATIC_ANALYZER') {
            staticConfig.style.display = 'block';
        }
    }
    
    // æµ‹è¯•æ¨¡å‹è¿æ¥
    function testModelConnection() {
        const formData = collectFormData();
        
        if (!validateFormData(formData)) {
            return;
        }
        
        const button = event.target;
        const originalText = button.textContent;
        
        button.textContent = 'æµ‹è¯•ä¸­...';
        button.disabled = true;
        
        fetch('/models/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.ok) {
                alert('è¿æ¥æµ‹è¯•æˆåŠŸï¼\n\n' + JSON.stringify(data.data, null, 2));
            } else {
                alert('è¿æ¥æµ‹è¯•å¤±è´¥ï¼š\n\n' + (data.error.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
            alert('æµ‹è¯•è¿æ¥å¤±è´¥ï¼š' + error.message);
        })
        .finally(() => {
            button.textContent = originalText;
            button.disabled = false;
        });
    }
    
    // ä¿å­˜æ¨¡å‹é…ç½®ï¼ˆç”±ä¸»é¡µé¢çš„saveModelå‡½æ•°å¤„ç†ï¼‰
    // è¯¥å‡½æ•°å·²ç§»è‡³model-management.html
    
    // æ”¶é›†è¡¨å•æ•°æ®
    function collectFormData() {
        const form = document.getElementById('model-form');
        const formData = new FormData(form);
        const data = {};
        
        // åŸºç¡€å­—æ®µ
        data.id = formData.get('id') || generateModelId();
        data.name = formData.get('name');
        data.displayName = formData.get('displayName');
        data.type = formData.get('type');
        data.description = formData.get('description');
        data.enabled = formData.has('enabled');
        
        // AIæ¨¡å‹ç‰¹å®šå­—æ®µ
        if (data.type === 'COMMERCIAL_AI' || data.type === 'LOCAL_AI') {
            data.apiUrl = formData.get('apiUrl');
            data.apiKey = formData.get('apiKey');
            data.modelName = formData.get('modelName');
            data.modelVersion = formData.get('modelVersion');
            data.maxTokens = formData.get('maxTokens') ? parseInt(formData.get('maxTokens')) : null;
            data.temperature = formData.get('temperature') ? parseFloat(formData.get('temperature')) : null;
            data.timeoutSeconds = formData.get('timeoutSeconds') ? parseInt(formData.get('timeoutSeconds')) : null;
            data.maxConcurrentRequests = formData.get('maxConcurrentRequests') ? parseInt(formData.get('maxConcurrentRequests')) : null;
        }
        
        // é™æ€åˆ†æå·¥å…·ç‰¹å®šå­—æ®µ
        if (data.type === 'STATIC_ANALYZER') {
            data.toolPath = formData.get('toolPath');
            data.configFile = formData.get('configFile');
            
            const languages = formData.get('supportedLanguages');
            data.supportedLanguages = languages ? languages.split(',').map(s => s.trim()).filter(s => s) : [];
            
            const fileTypes = formData.get('supportedFileTypes');
            data.supportedFileTypes = fileTypes ? fileTypes.split(',').map(s => s.trim()).filter(s => s) : [];
        }
        
        // æ”¯æŒçš„ç»´åº¦
        const dimensions = [];
        formData.getAll('supportedDimensions').forEach(dim => {
            if (dim) dimensions.push(dim);
        });
        data.supportedDimensions = dimensions;
        
        // æ’é™¤æ¨¡å¼
        const excludePatterns = formData.get('excludePatterns');
        data.excludePatterns = excludePatterns ? excludePatterns.split('\n').map(s => s.trim()).filter(s => s) : [];
        
        return data;
    }
    
    // éªŒè¯è¡¨å•æ•°æ®
    function validateFormData(data) {
        if (!data.name || data.name.trim() === '') {
            alert('è¯·è¾“å…¥æ¨¡å‹åç§°');
            return false;
        }
        
        if (!data.type) {
            alert('è¯·é€‰æ‹©æ¨¡å‹ç±»å‹');
            return false;
        }
        
        if (data.type === 'COMMERCIAL_AI' || data.type === 'LOCAL_AI') {
            if (!data.apiUrl || data.apiUrl.trim() === '') {
                alert('è¯·è¾“å…¥APIåœ°å€');
                return false;
            }
            
            if (data.type === 'COMMERCIAL_AI' && (!data.apiKey || data.apiKey.trim() === '')) {
                alert('è¯·è¾“å…¥APIå¯†é’¥');
                return false;
            }
            
            if (!data.modelName || data.modelName.trim() === '') {
                alert('è¯·è¾“å…¥æ¨¡å‹åç§°');
                return false;
            }
        }
        
        if (data.type === 'STATIC_ANALYZER') {
            if (!data.toolPath || data.toolPath.trim() === '') {
                alert('è¯·è¾“å…¥å·¥å…·è·¯å¾„');
                return false;
            }
        }
        
        return true;
    }
    
    // ç”Ÿæˆæ¨¡å‹IDï¼ˆç”±ä¸»é¡µé¢çš„generateModelIdå‡½æ•°å¤„ç†ï¼‰
    // è¯¥å‡½æ•°å·²ç§»è‡³model-management.html
    
    // è¡¨å•åˆå§‹åŒ–å‡½æ•°
    function initializeModelForm() {
        console.log('Initializing model form...');
        
        setTimeout(() => {
            const typeSelect = document.getElementById('model-type');
            if (typeSelect) {
                console.log('Model type found:', typeSelect.value);
                typeSelect.addEventListener('change', handleFormTypeChange);
                handleFormTypeChange(); // è§¦å‘åˆå§‹æ˜¾ç¤º
            } else {
                console.error('Model type select not found');
            }
        }, 100);
    }
</script>
</html>
