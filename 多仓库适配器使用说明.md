# 🔗 AI Code Reviewer 多仓库适配器使用说明

## 📋 概述

AI Code Reviewer 现已支持多种 Git 平台的统一接入，提供一致的 AI 代码审查体验：

### ✅ 支持的平台

| 平台 | 状态 | 认证方式 | Webhook 支持 |
|------|------|----------|-------------|
| **GitHub** | ✅ 完整支持 | Token / App | ✅ |
| **GitLab** | ✅ 完整支持 | Token / OAuth | ✅ |
| **Bitbucket** | ✅ 基础支持 | App Password | ✅ |
| **Gitea** | 🚧 开发中 | Token | ✅ |
| **自建 Git** | 🚧 开发中 | Token | ✅ |

## 🛠️ 配置方式

### 1. GitHub 配置

```yaml
ai-reviewer:
  scm:
    github:
      api-base: https://api.github.com
      web-base: https://github.com
      token: ${GITHUB_TOKEN}
      client-id: ${GITHUB_CLIENT_ID}
      client-secret: ${GITHUB_CLIENT_SECRET}
      webhook-secret: ${GITHUB_WEBHOOK_SECRET}
```

**环境变量：**
```bash
export GITHUB_TOKEN="ghp_your_github_token"
export GITHUB_CLIENT_ID="your_github_app_client_id"
export GITHUB_CLIENT_SECRET="your_github_app_client_secret"
export GITHUB_WEBHOOK_SECRET="your_webhook_secret"
```

### 2. GitLab 配置

```yaml
ai-reviewer:
  scm:
    gitlab:
      api-base: https://gitlab.com/api/v4
      web-base: https://gitlab.com
      token: ${GITLAB_TOKEN}
      client-id: ${GITLAB_CLIENT_ID}
      client-secret: ${GITLAB_CLIENT_SECRET}
      webhook-secret: ${GITLAB_WEBHOOK_SECRET}
```

**环境变量：**
```bash
export GITLAB_TOKEN="glpat_your_gitlab_token"
export GITLAB_CLIENT_ID="your_gitlab_app_client_id"
export GITLAB_CLIENT_SECRET="your_gitlab_app_client_secret"
export GITLAB_WEBHOOK_SECRET="your_webhook_secret"
```

### 3. Bitbucket 配置

```yaml
ai-reviewer:
  scm:
    bitbucket:
      api-base: https://api.bitbucket.org/2.0
      web-base: https://bitbucket.org
      username: ${BITBUCKET_USERNAME}
      app-password: ${BITBUCKET_APP_PASSWORD}
      webhook-secret: ${BITBUCKET_WEBHOOK_SECRET}
```

**环境变量：**
```bash
export BITBUCKET_USERNAME="your_bitbucket_username"
export BITBUCKET_APP_PASSWORD="your_app_password"
export BITBUCKET_WEBHOOK_SECRET="your_webhook_secret"
```

### 4. Gitea 配置

```yaml
ai-reviewer:
  scm:
    gitea:
      api-base: ${GITEA_API_BASE}  # 例如: https://gitea.example.com/api/v1
      web-base: ${GITEA_WEB_BASE}  # 例如: https://gitea.example.com
      token: ${GITEA_TOKEN}
      webhook-secret: ${GITEA_WEBHOOK_SECRET}
      ssl-verify: ${GITEA_SSL_VERIFY:true}
```

**环境变量：**
```bash
export GITEA_API_BASE="https://gitea.example.com/api/v1"
export GITEA_WEB_BASE="https://gitea.example.com"
export GITEA_TOKEN="your_gitea_token"
export GITEA_WEBHOOK_SECRET="your_webhook_secret"
export GITEA_SSL_VERIFY="true"
```

### 5. 自建 Git 配置

```yaml
ai-reviewer:
  scm:
    custom-git:
      api-base: ${CUSTOM_GIT_API_BASE}
      web-base: ${CUSTOM_GIT_WEB_BASE}
      token: ${CUSTOM_GIT_TOKEN}
      webhook-secret: ${CUSTOM_GIT_WEBHOOK_SECRET}
      ssl-verify: ${CUSTOM_GIT_SSL_VERIFY:true}
      api-type: ${CUSTOM_GIT_API_TYPE:gitea}  # gitea, gitlab, github
```

**环境变量：**
```bash
export CUSTOM_GIT_API_BASE="https://git.yourcompany.com/api/v1"
export CUSTOM_GIT_WEB_BASE="https://git.yourcompany.com"
export CUSTOM_GIT_TOKEN="your_git_token"
export CUSTOM_GIT_WEBHOOK_SECRET="your_webhook_secret"
export CUSTOM_GIT_SSL_VERIFY="true"
export CUSTOM_GIT_API_TYPE="gitea"  # 根据实际API兼容性选择
```

## 🔗 Webhook 端点

### 统一 Webhook 端点

| 平台 | Webhook URL | 示例 |
|------|-------------|------|
| **GitHub** | `POST /api/webhooks/github` | `https://your-ai-reviewer.com/api/webhooks/github` |
| **GitLab** | `POST /api/webhooks/gitlab` | `https://your-ai-reviewer.com/api/webhooks/gitlab` |
| **Bitbucket** | `POST /api/webhooks/bitbucket` | `https://your-ai-reviewer.com/api/webhooks/bitbucket` |
| **Gitea** | `POST /api/webhooks/gitea` | `https://your-ai-reviewer.com/api/webhooks/gitea` |
| **通用** | `POST /api/webhooks/generic` | `https://your-ai-reviewer.com/api/webhooks/generic` |

### Webhook 事件支持

| 事件类型 | GitHub | GitLab | Bitbucket | Gitea |
|---------|--------|--------|-----------|-------|
| **Pull Request Opened** | ✅ | ✅ | ✅ | ✅ |
| **Pull Request Updated** | ✅ | ✅ | ✅ | ✅ |
| **Pull Request Closed** | ✅ | ✅ | ✅ | ✅ |
| **Push Events** | ✅ | ✅ | ✅ | ✅ |

## 🚀 API 端点

### 支持的提供商查询

```bash
GET /api/webhooks/providers
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "supported": ["github", "gitlab", "bitbucket", "gitea", "custom-git"],
    "health": {
      "github": true,
      "gitlab": true,
      "bitbucket": true,
      "gitea": false,
      "custom-git": false
    },
    "adapters": {
      "github": "GithubAdapter",
      "gitlab": "GitlabAdapter",
      "bitbucket": "BitbucketAdapter",
      "gitea": "GiteaAdapter",
      "custom-git": "CustomGitAdapter"
    }
  }
}
```

### 仓库支持检查

```bash
GET /api/webhooks/check-support?repoUrl=https://github.com/owner/repo
```

**响应示例：**
```json
{
  "success": true,
  "data": {
    "repoUrl": "https://github.com/owner/repo",
    "supported": true,
    "supportedProviders": ["github", "gitlab", "bitbucket", "gitea", "custom-git"]
  }
}
```

## 📝 使用示例

### 1. GitHub 仓库

```bash
# 配置 webhook
curl -X POST https://api.github.com/repos/owner/repo/hooks \
  -H "Authorization: token $GITHUB_TOKEN" \
  -d '{
    "name": "web",
    "active": true,
    "events": ["pull_request"],
    "config": {
      "url": "https://your-ai-reviewer.com/api/webhooks/github",
      "content_type": "json",
      "secret": "your_webhook_secret"
    }
  }'
```

### 2. GitLab 仓库

```bash
# 配置 webhook  
curl -X POST https://gitlab.com/api/v4/projects/:id/hooks \
  -H "PRIVATE-TOKEN: $GITLAB_TOKEN" \
  -d '{
    "url": "https://your-ai-reviewer.com/api/webhooks/gitlab",
    "merge_requests_events": true,
    "push_events": true,
    "token": "your_webhook_secret"
  }'
```

### 3. Bitbucket 仓库

```bash
# 配置 webhook
curl -X POST https://api.bitbucket.org/2.0/repositories/owner/repo/hooks \
  -u "$BITBUCKET_USERNAME:$BITBUCKET_APP_PASSWORD" \
  -H "Content-Type: application/json" \
  -d '{
    "description": "AI Code Reviewer",
    "url": "https://your-ai-reviewer.com/api/webhooks/bitbucket",
    "active": true,
    "events": ["pullrequest:created", "pullrequest:updated"]
  }'
```

## 🔧 故障排除

### 常见问题

1. **Webhook 签名验证失败**
   - 检查 webhook secret 配置是否正确
   - 确认 webhook URL 和 secret 在平台配置中一致

2. **API 认证失败**
   - 验证 token 是否有效且有足够权限
   - 检查 API base URL 是否正确

3. **自建 Git 服务器连接失败**
   - 确认 API type 配置正确（gitea/gitlab/github）
   - 检查 SSL 证书配置
   - 验证网络连接和防火墙设置

### 调试日志

启用调试日志查看详细信息：

```yaml
logging:
  level:
    com.ai.reviewer.backend.infra.adapter: DEBUG
    com.ai.reviewer.backend.api.controller.WebhookController: DEBUG
```

### 健康检查

```bash
# 检查所有适配器状态
GET /api/webhooks/providers

# 检查特定仓库支持
GET /api/webhooks/check-support?repoUrl=YOUR_REPO_URL
```

## 📊 监控指标

AI Code Reviewer 提供以下监控指标：

- **适配器健康状态**: 各平台适配器的连接状态
- **Webhook 处理统计**: 接收和处理的 webhook 数量
- **API 调用统计**: 各平台 API 调用成功率和延迟
- **审查任务统计**: 触发和完成的审查任务数量

## 🔄 升级和维护

### 版本兼容性

| AI Reviewer 版本 | 支持的平台版本 |
|------------------|---------------|
| **1.0.0+** | GitHub API v4, GitLab API v4, Bitbucket API v2.0, Gitea API v1 |

### 配置迁移

从单平台配置迁移到多平台配置时，只需：

1. 保持原有配置不变
2. 添加新平台的配置块
3. 重启服务，新配置自动生效

### 性能优化

- **连接池配置**: 根据使用量调整 HTTP 连接池大小
- **缓存策略**: 启用 API 响应缓存减少调用次数
- **批量处理**: 对于大量 webhook 事件，启用批量处理模式
